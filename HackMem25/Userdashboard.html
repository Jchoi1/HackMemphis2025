<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard | 901-211</title>
  <link rel="stylesheet" href="Userdashboard.css" />
</head>

<body>
  <header class="dash-header">
    <h1>901-211</h1>
    <div class="head-btns">
      <button id="needBtn" class="need-btn">I Need Help</button>
      <button id="logoutBtn">Logout</button>
      <button id="homeBtn" class="need-btn">Home</button>
    </div>
  </header>

  <main id="tabContent">
    <section id="home" class="tab active">
      <h2>Welcome, Grizzly!</h2>
      <input id="searchBar" placeholder="Search resourcesâ€¦" />
      <div id="bizList" class="biz-grid"></div>
    </section>

    <section id="faves" class="tab">
      <h2>Your Favorites</h2>
      <div id="faveList" class="biz-grid"></div>
    </section>

    <section id="map" class="tab">
      <h2>Map View</h2>
      <div id="mapCanvas" class="map-box"></div> <!-- Map container -->
    </section>

    <section id="profile" class="tab">
      <h2>Profile</h2>
      <p>Username: <span id="showUser"></span></p>
      <button id="clearFaves">Clear Favorites</button>
    </section>
  </main>

  <nav class="bottom-nav">
    <button data-tab="home" class="nav-btn active">Home</button>
    <button data-tab="faves" class="nav-btn">Favorites</button>
    <button data-tab="map" class="nav-btn">Map</button>
    <button data-tab="profile" class="nav-btn">Profile</button>
  </nav>
 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM-4UJhyj9k94IzpJDzV_fhi-OVlutLe0" async defer></script>

  <script>
  // TAB SWITCHING
  let mapInitialized = false;
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');

      if (btn.dataset.tab === 'home') loadBiz();
      if (btn.dataset.tab === 'faves') loadFaves();
      if (btn.dataset.tab === 'profile') showProfile();

      // Initialize Map when opening map tab
      if (btn.dataset.tab === 'map' && !mapInitialized) {
        setTimeout(() => {
          initMap();
          mapInitialized = true;
        }, 200);
      }
    });
  });

  document.getElementById('homeBtn')?.addEventListener('click', () => {
    location = 'Userdashboard.html';
  });
  document.getElementById('needBtn').addEventListener('click', () => {
    location = 'filter.html';
  });

  // DEMO DATA
  const dummyBiz = [
    {id:1, name:"Mid-South Food Bank", categories:["Food"], desc:"Groceries & hot meals"},
    {id:2, name:"Memphis Health Center", categories:["Health"], desc:"Free medical clinic"},
    {id:3, name:"United Way Housing", categories:["Housing"], desc:"Emergency shelter"}
  ];

  function loadBiz(list = dummyBiz) {
    const box = document.getElementById('bizList');
    box.innerHTML = list.map(b => `
      <div class="biz-card">
        <h4>${b.name}</h4>
        <p>${b.categories.join(', ')} â€¢ ${b.desc}</p>
        <div class="card-actions">
          <button onclick="toggleFav(${b.id})" title="Favorite">â˜†</button>
          <button onclick="reportBiz(${b.id})" title="Report">ðŸš©</button>
        </div>
      </div>`).join('');
  }

  function reportBiz(id) {
    const reason = prompt('What needs to be reported?\n(e.g. hours wrong, location closed, etc.)');
    if (!reason) return;
    fetch('/api/report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bizId: id, reason, user: localStorage.getItem('savedUsername') || 'Guest' })
    }).then(r => r.json()).then(res => {
      alert(res.ok ? 'Report sent â€“ thank you!' : 'Report failed.');
    });
  }

  let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

  function toggleFav(id) {
    favorites = favorites.includes(id) ? favorites.filter(x => x !== id) : [...favorites, id];
    localStorage.setItem('favorites', JSON.stringify(favorites));
    loadBiz();
  }

  function loadFaves() {
    const favBiz = dummyBiz.filter(b => favorites.includes(b.id));
    document.getElementById('faveList').innerHTML = favBiz.length
      ? favBiz.map(b => `
          <div class="biz-card">
            <h4>${b.name}</h4>
            <p>${b.categories.join(', ')} â€¢ ${b.desc}</p>
          </div>`).join('')
      : '<p>No favorites yet.</p>';
  }

  function showProfile() {
    document.getElementById('showUser').textContent = localStorage.getItem('savedUsername') || 'Guest';
  }

  document.getElementById('clearFaves').addEventListener('click', () => {
    favorites = [];
    localStorage.removeItem('favorites');
    loadFaves();
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    location = 'Generalhomepage.html';
  });

  // MAP
  let map;
  function initMap() {
    const memphis = { lat: 35.1495, lng: -90.0490 };

    map = new google.maps.Map(document.getElementById("mapCanvas"), {
      center: memphis,
      zoom: 12
    });

    dummyBiz.forEach(b => {
      new google.maps.Marker({
        position: {
          lat: memphis.lat + Math.random() * 0.05,
          lng: memphis.lng + Math.random() * 0.05
        },
        map,
        title: b.name
      });
    });
  }

  // Initial load
  loadBiz();
  </script>

  <!-- Google Maps API -->
  <!-- Replace YOUR_API_KEY with your actual key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAo7WiUQW6GJ-x62R9JVrB-kNXpud7YP84"></script>
</body>
</html>
